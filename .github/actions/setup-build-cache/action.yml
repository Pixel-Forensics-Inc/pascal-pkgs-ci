name: Setup build cache

runs:
  using: "composite"

  steps:
    - name: Set environment variables
      shell: bash
      run: |
        echo "SCCACHE_GHA_ENABLED=1" | tee -a "$GITHUB_ENV"
        echo "SCCACHE_DIRECT=1"      | tee -a "$GITHUB_ENV"

    - name: Install sccache
      uses: mozilla-actions/sccache-action@v0.0.5

    - name: Backup sccache
      shell: bash
      run: cp /opt/hostedtoolcache/sccache/*/*/sccache /tmp/sccache

    - name: Install fake sccache
      shell: bash
      run: |
        cat << "EOF" | install /dev/stdin /opt/hostedtoolcache/sccache/*/*/sccache
        #!/bin/sh -e

        if [ $# -eq 1 ] && [ "$1" = "--show-stats" ]; then
          exec cat /tmp/sccache_stats.txt
        fi

        if [ $# -eq 2 ] && [ "$1" = "--show-stats" ] && [ "$2" = "--stats-format=json" ]; then
          exec cat /tmp/sccache_stats.json
        fi

        exit 1
        EOF
